<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLATECOLLECTOR PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: sans-serif; background-color: #020617; color: white; margin: 0; height: 100vh; overflow: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Splash Screen que no bloquea */
        #splash { 
            position: fixed; inset: 0; background: #020617; z-index: 9999; 
            display: flex; align-items: center; justify-content: center;
        }
        #splash img { width: 100%; max-width: 400px; height: auto; }

        .numpad-btn { 
            background: rgba(255,255,255,0.1); height: 60px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.5rem; font-weight: bold; cursor: pointer;
        }
        .numpad-btn:active { background: #eab308; color: black; }
        
        .modal { position: fixed; inset: 0; background: #020617; z-index: 100; display: none; padding: 20px; }
        .modal.active { display: block; }

        .scroll-x { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; }
        .scroll-x::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">

    <div id="splash" onclick="this.remove()">
        <img src="icono.png" alt="Cargando...">
    </div>

    <div id="profile-screen" class="fixed inset-0 z-[500] bg-slate-950 p-6 flex flex-col items-center justify-center">
        <h1 class="text-3xl font-black mb-8 italic text-yellow-500 uppercase">¿Quién eres?</h1>
        <div class="w-full max-w-xs space-y-4">
            <button onclick="login('Noa')" class="w-full glass p-4 rounded-2xl flex items-center gap-4 text-xl font-bold">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Noa" class="w-10 h-10 rounded-full"> NOA
            </button>
            <button onclick="login('Erik')" class="w-full glass p-4 rounded-2xl flex items-center gap-4 text-xl font-bold">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Erik" class="w-10 h-10 rounded-full"> ERIK
            </button>
            <button onclick="login('Fer')" class="w-full glass p-4 rounded-2xl flex items-center gap-4 text-xl font-bold">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Fer" class="w-10 h-10 rounded-full"> FER
            </button>
            <div class="pt-4">
                <input type="text" id="guest-name" placeholder="Tu nombre..." class="w-full bg-slate-900 p-4 rounded-xl mb-2 text-white border border-white/10">
                <button onclick="register()" class="w-full bg-yellow-500 text-black font-bold p-4 rounded-xl">REGISTRAR NUEVO</button>
            </div>
        </div>
    </div>

    <header class="p-4 flex justify-between items-center bg-slate-900 pt-10">
        <span id="display-user" class="font-bold text-yellow-500">---</span>
        <span id="display-points" class="font-black text-2xl">0</span>
    </header>

    <main class="flex-1 p-4 overflow-y-auto pb-24 text-center">
        <div class="scroll-x mb-4" id="blocks"></div>
        
        <div class="glass p-10 rounded-[2.5rem] mb-6 text-6xl font-mono tracking-widest" id="plate-view">____</div>

        <div class="grid grid-cols-3 gap-3">
            <div onclick="press(1)" class="numpad-btn">1</div>
            <div onclick="press(2)" class="numpad-btn">2</div>
            <div onclick="press(3)" class="numpad-btn">3</div>
            <div onclick="press(4)" class="numpad-btn">4</div>
            <div onclick="press(5)" class="numpad-btn">5</div>
            <div onclick="press(6)" class="numpad-btn">6</div>
            <div onclick="press(7)" class="numpad-btn">7</div>
            <div onclick="press(8)" class="numpad-btn">8</div>
            <div onclick="press(9)" class="numpad-btn">9</div>
            <div onclick="del()" class="numpad-btn text-red-500"><i class="fas fa-backspace"></i></div>
            <div onclick="press(0)" class="numpad-btn">0</div>
            <div onclick="send()" class="numpad-btn bg-yellow-500 text-black"><i class="fas fa-check"></i></div>
        </div>
    </main>

    <nav class="fixed bottom-0 inset-x-0 h-20 bg-black flex justify-around items-center z-[1000]">
        <button onclick="closeModals()" class="text-yellow-500"><i class="fas fa-plus-circle text-2xl"></i></button>
        <button onclick="openM('ranking')" class="text-slate-500"><i class="fas fa-trophy text-2xl"></i></button>
        <button onclick="openM('comun')" class="text-slate-500"><i class="fas fa-users text-2xl"></i></button>
        <button onclick="logout()" class="text-slate-500"><i class="fas fa-sign-out-alt text-2xl"></i></button>
    </nav>

    <div id="m-ranking" class="modal">
        <div class="flex justify-between items-center mb-6 pt-10">
            <h2 class="text-2xl font-bold">RANKING</h2>
            <button onclick="closeModals()" class="text-3xl">&times;</button>
        </div>
        <div id="rank-list" class="space-y-2"></div>
    </div>

    <div id="m-comun" class="modal text-center">
        <div class="flex justify-between items-center mb-6 pt-10">
            <h2 class="text-2xl font-bold">EQUIPO</h2>
            <button onclick="closeModals()" class="text-3xl">&times;</button>
        </div>
        <p class="text-slate-400">Total capturas:</p>
        <h3 id="total-global" class="text-7xl font-black text-cyan-500 mt-4">0</h3>
    </div>

    <script>
        const config = { databaseURL: "https://el-coleccionista-de-matriculas-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(config);
        const db = firebase.database();

        let user = null;
        let plate = "";

        // Generar 0-9
        for(let i=0; i<=9; i++){
            document.getElementById('blocks').innerHTML += `<div id="b-${i}" class="glass min-w-[60px] h-[60px] rounded-xl flex items-center justify-center font-bold">${i}</div>`;
        }

        function login(name) {
            user = name;
            localStorage.setItem('u', name);
            document.getElementById('profile-screen').style.display = 'none';
            init();
        }

        function register() {
            const n = document.getElementById('guest-name').value;
            if(n) login(n);
        }

        function init() {
            document.getElementById('display-user').innerText = user;
            db.ref('users/' + user).on('value', s => {
                const d = s.val() || {points:0, blocks:{}};
                document.getElementById('display-points').innerText = d.points;
                for(let i=0; i<=9; i++) {
                    const b = document.getElementById('b-'+i);
                    b.style.borderColor = (d.blocks && d.blocks[i]) ? '#eab308' : 'transparent';
                    b.style.color = (d.blocks && d.blocks[i]) ? '#eab308' : 'white';
                }
            });
            db.ref('users').on('value', s => {
                const all = s.val() || {};
                const sort = Object.entries(all).sort((a,b) => b[1].points - a[1].points);
                let h = ''; let t = 0;
                sort.forEach(([n, d]) => {
                    t += (d.captures || 0);
                    h += `<div class="glass p-3 rounded-xl flex justify-between"><span>${n}</span><b>${d.points}</b></div>`;
                });
                document.getElementById('rank-list').innerHTML = h;
                document.getElementById('total-global').innerText = t;
            });
        }

        function press(n) { if(plate.length < 4) { plate += n; up(); } }
        function del() { plate = plate.slice(0, -1); up(); }
        function up() { document.getElementById('plate-view').innerText = plate.padEnd(4, '_'); }

        function send() {
            if(plate.length === 4) {
                const ref = db.ref('users/' + user);
                ref.once('value').then(s => {
                    let d = s.val() || {points:0, captures:0, blocks:{}};
                    d.points += 5; d.captures += 1;
                    if(!d.blocks) d.blocks = {};
                    d.blocks[plate[0]] = true;
                    ref.set(d);
                    plate = ""; up();
                });
            }
        }

        function openM(id) { closeModals(); document.getElementById('m-'+id).classList.add('active'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        function logout() { localStorage.removeItem('u'); location.reload(); }

        setTimeout(() => { if(document.getElementById('splash')) document.getElementById('splash').remove(); }, 3000);
        window.onload = () => { if(localStorage.getItem('u')) login(localStorage.getItem('u')); };
    </script>
</body>
</html>
